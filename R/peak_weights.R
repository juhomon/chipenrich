
# This function calculates a weight for each peak according to how many loci it intersects.
calc_peak_weights = function(assigned_peaks) {
	peak_counts = table(assigned_peaks$peak_id)
	peak_weights = data.frame(
		'peak_id' = names(peak_counts),
		'peak_weight' = as.numeric(1 / peak_counts),
		stringsAsFactors=F)
	
	assigned_peaks = merge(assigned_peaks, peak_weights, by='peak_id')
	
	return(assigned_peaks)
}


# Used for Chris's new method development
# Adds gene_weight column to the peaks per gene result
# Currently the gene_weight is the sum of the peak weights overlapping the locus
calc_genes_peak_weight = function(assigned_peaks, ppg) {
	# Sum up the peak weights for each peak in a gene
	assigned_peaks$peak_weight = assigned_peaks$peak_weight/mean(assigned_peaks$peak_weight)
	rpg = stats::aggregate(peak_weight ~ gene_id, assigned_peaks, sum)
	
	d_rpg = data.frame(gene_id = rpg$gene_id, peak_weight = rpg$peak_weight, stringsAsFactors=F)
	
	result = merge(ppg, d_rpg, by='gene_id', all.x=T)
	result$peak_weight[is.na(result$peak_weight)] = 0
	
	# Order by number of peaks in a gene.
	result = result[order(result$num_peaks,decreasing=T),]
	
	return(result)
}